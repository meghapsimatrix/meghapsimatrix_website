{
  "hash": "02c4106f8474acc65c8e2b6f66d4efab",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Individual Participant Data Meta-Analysis: Example with R\"\nauthor: \"Megha Joshi\"\ndate: 2022-12-06\ncategories: [\"meta-analyis\", \"heterogeneity\", \"ipdma\"]\nbibliography: references.bib\ncsl: apa.csl\ndraft: false\n---\n\n\n\n\n\n## Aggregated Data Meta-Analysis and IPDMA\n\nTraditional meta-analyses use aggregated or summary level information from studies or reports [@cooper_patall_2009; @riley_lambert_abozaid_2010]. Analysts conducting aggregated data meta-analysis would look up relevant literature and code summary statistics needed to calculate one or more effect sizes from each study and also code the corresponding moderator variables. And, then run meta-regression models to (1) summarize effect size estimates across studies, (2) characterize variability in effect sizes across studies, and (3) explain the variability in the effect sizes. Moderator variables will be at the effect size-level or the study-level (e.g., the outcome measure or the percentage of economically disadvantaged students in the sample used to calculate the effect). One drawback of aggregated data meta-analysis is that we cannot examine the effect of moderators at the individual level. For example, we can say that studies with higher percentage of economically disadvantaged students tend to have higher effects of some treatment. However, we cannot say that the treatment works better for economically disadvantaged students. To do so would be to commit [ecological fallacy](https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-021-01310-0) [@geissbuehler_hincapie_aghmandi_et_al_2021].\n\nAnother way of conducting meta-analysis is to use individual participant-level data instead of aggregated summaries [@riley_lambert_abozaid_2010]. For each study in the meta-analysis, the analyst would have access to the individual-level data. Outcomes and moderator variables will be at the individual level (e.g., students' scores on an achievement test and indicator for whether or not they are economically disadvantaged). Because data is at the individual-level, analysts can conduct subgroup analyses to examine the potentially heterogeneous effects of a treatment for different subgroups [@cooper_patall_2009]. The feasibility of conducting such subgroup analyses provides IPDMA a major advantage over aggregated data meta-analysis, which heavily rely on the analyses conducted by primary study authors who may not have reported results from subgroup analyses.\n\n## IPDMA Analyses in R\n\nThere are two ways do conduct IPDMA: (1) one-stage meta-analysis which involves analyzing data from all studies at once; and, (2) two-stage meta-analysis which involves first analyzing individual data separately for each primary study and then synthesizing the effects using meta-regression models [@riley_lambert_abozaid_2010; @cooper_patall_2009]. I will walk through how to run each of these using an example data.\n\n### Example Dataset\n\nI've [tried to](https://twitter.com/jepusto/status/1539286748034916353) find a publicly available IPDMA dataset to use as an example. However, I haven't found one appropriate for this post. Thus, I am using a dataset is from a [block randomized study](https://www.pnas.org/content/113/39/10830) [@bryan_yeager_hinojosa_chabot_bergen_kawamura_steubing_2016]. Blocks can be somewhat thought of as different studies in a meta-analysis (not the same thing but please go along for this post). In the data, students were randomized within classes. There are 30 classrooms (like 30 different studies) within which participants were randomized. The study examined the effects of brief psychological interventions on eating behaviors. The outcome that I am going to analyze is `autonprosocial`, four-item self-report measure of alignment of healthy eating with adolescent values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(knitr)\nlibrary(estimatr)\nlibrary(metafor)\nlibrary(lme4)\nlibrary(lmerTest)\nlibrary(broom)\nlibrary(broom.mixed)\nlibrary(kableExtra)\nlibrary(janitor)\n\noptions(knitr.kable.NA = '')\n\nbryan_dat <- read_csv(\"https://raw.githubusercontent.com/meghapsimatrix/datasets/master/causal/bryan_dat.csv\")\n\nglimpse(bryan_dat %>% select(classroom, condition, condition_collapsed, female, autonprosocial))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 501\nColumns: 5\n$ classroom           <chr> \"B2\", \"B2\", \"A1\", \"A2\", \"B3\", \"A3\", \"B4\", \"B2\", \"D…\n$ condition           <chr> \"expose treatment\", \"expose treatment\", \"no treatm…\n$ condition_collapsed <chr> \"expose treatment\", \"expose treatment\", \"control\",…\n$ female              <dbl> 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1,…\n$ autonprosocial      <dbl> 3.75, 4.25, 2.25, 4.25, 3.25, 3.25, 4.25, 1.25, 2.…\n```\n\n\n:::\n:::\n\n\n\n### One Stage IPDMA\n\nOne stage IPDMA basically involves running one analysis on all the data accounting for clustering by study. Below I am running HLM using `lmer()` from [`lme4`](https://cran.r-project.org/web/packages/lme4/index.html) package specifying fixed intercepts but random slopes for treatment effect by classroom. The model that I am using is based on suggestion by @bloom2017using. The results table shows the treatment effect estimate (and it's se etc.) and also the estimate of the standard deviation of the treatment effects across classrooms.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# creating treatment indicator\nbryan_dat <-\n  bryan_dat %>%\n  mutate(trt_ind = as.integer(condition_collapsed == \"expose treatment\"))\n\n\n# function to estimate treatment effects\nestimate_effects <- function(dat, stage){\n  \n  if(stage == \"one\"){\n    \n    mod <- lmer(autonprosocial ~ 0 + classroom + trt_ind + \n                (0 + trt_ind | classroom), \n                data = dat)\n  \n  } else if(stage == \"two\") {\n    \n    mod <- lm_robust(autonprosocial ~ trt_ind, data = dat)\n    \n  }\n  \n  res <- tidy(mod) %>%\n    filter(str_detect(term, \"trt_ind\")) %>%\n    clean_names() %>%\n    mutate(v = std_error^2)\n  \n  return(res)\n  \n}\n\n\n\n# estimate of treatment effect and the sd of treatment effect across classrooms\nestimate_effects(bryan_dat, stage = \"one\") %>%\n  kable(digits = 3) \n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> effect </th>\n   <th style=\"text-align:left;\"> group </th>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std_error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> df </th>\n   <th style=\"text-align:right;\"> p_value </th>\n   <th style=\"text-align:right;\"> v </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> fixed </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> trt_ind </td>\n   <td style=\"text-align:right;\"> 1.157 </td>\n   <td style=\"text-align:right;\"> 0.083 </td>\n   <td style=\"text-align:right;\"> 14.014 </td>\n   <td style=\"text-align:right;\"> 25.776 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.007 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ran_pars </td>\n   <td style=\"text-align:left;\"> classroom </td>\n   <td style=\"text-align:left;\"> sd__trt_ind </td>\n   <td style=\"text-align:right;\"> 0.146 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n#### Subgroup Analyses\n\nBelow I am creating subgroups based on the `female` variable and estimating the treatment effect and the sd of treatment effects across classrooms for each subgroup:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbryan_dat <- bryan_dat %>%\n  mutate(female = ifelse(female == 1, \"Female\", \"Not Female\"))\n\nbryan_dat %>%\n  group_by(female) %>%\n  do(estimate_effects(., stage = \"one\")) %>%\n  kable(digits = 3)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nboundary (singular) fit: see help('isSingular')\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> female </th>\n   <th style=\"text-align:left;\"> effect </th>\n   <th style=\"text-align:left;\"> group </th>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std_error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> df </th>\n   <th style=\"text-align:right;\"> p_value </th>\n   <th style=\"text-align:right;\"> v </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:left;\"> fixed </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> trt_ind </td>\n   <td style=\"text-align:right;\"> 1.217 </td>\n   <td style=\"text-align:right;\"> 0.109 </td>\n   <td style=\"text-align:right;\"> 11.187 </td>\n   <td style=\"text-align:right;\"> 232 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.012 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:left;\"> ran_pars </td>\n   <td style=\"text-align:left;\"> classroom </td>\n   <td style=\"text-align:left;\"> sd__trt_ind </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Not Female </td>\n   <td style=\"text-align:left;\"> fixed </td>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:left;\"> trt_ind </td>\n   <td style=\"text-align:right;\"> 1.043 </td>\n   <td style=\"text-align:right;\"> 0.115 </td>\n   <td style=\"text-align:right;\"> 9.058 </td>\n   <td style=\"text-align:right;\"> 207 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.013 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Not Female </td>\n   <td style=\"text-align:left;\"> ran_pars </td>\n   <td style=\"text-align:left;\"> classroom </td>\n   <td style=\"text-align:left;\"> sd__trt_ind </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n   <td style=\"text-align:right;\">  </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### Two Stage IPDMA\n\n#### First Stage: Primary Study Analysis\n\nFirst, I estimate the average treatment effect by block. For IPDMA, we would estimate the treatment effects for each primary study:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_stage_res <-\n  bryan_dat %>%\n  group_by(classroom) %>%\n  do(estimate_effects(., stage = \"two\")) \n\nglimpse(first_stage_res)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 30\nColumns: 11\nGroups: classroom [30]\n$ classroom <chr> \"A1\", \"A2\", \"A3\", \"A4\", \"A5\", \"A6\", \"B1\", \"B2\", \"B3\", \"B4\", …\n$ term      <chr> \"trt_ind\", \"trt_ind\", \"trt_ind\", \"trt_ind\", \"trt_ind\", \"trt_…\n$ estimate  <dbl> 1.7951128, 1.4062500, 0.1250000, 0.9318182, 0.9130952, 1.333…\n$ std_error <dbl> 0.2744876, 0.2830958, 0.3683758, 0.2781655, 0.3595215, 0.496…\n$ statistic <dbl> 6.5398688, 4.9673998, 0.3393274, 3.3498700, 2.5397511, 2.687…\n$ p_value   <dbl> 9.175979e-07, 3.266890e-04, 7.387762e-01, 4.386511e-03, 2.11…\n$ conf_low  <dbl> 1.2285983, 0.7894372, -0.6559219, 0.3389225, 0.1545711, 0.28…\n$ conf_high <dbl> 2.3616273, 2.0230628, 0.9059219, 1.5247139, 1.6716194, 2.380…\n$ df        <dbl> 24, 12, 16, 15, 17, 17, 7, 32, 26, 19, 16, 10, 12, 11, 18, 1…\n$ outcome   <chr> \"autonprosocial\", \"autonprosocial\", \"autonprosocial\", \"auton…\n$ v         <dbl> 0.07534343, 0.08014323, 0.13570076, 0.07737603, 0.12925574, …\n```\n\n\n:::\n:::\n\n\n\n#### Second Stage: Meta-Analysis\n\nThen, in the second stage, I synthesize the block specific treatment effects using [metafor::rma.uni()](https://wviechtb.github.io/metafor/reference/rma.uni.html), which weighs each effect size estimate by its precision:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsecond_stage_res <- rma.uni(yi = estimate, \n                            sei = std_error,\n                            data = first_stage_res, \n                            method = \"REML\", \n                            test = \"knha\")\n\ntibble(\n  rowname = rownames(second_stage_res$b),\n  estimate = as.vector(second_stage_res$b),\n  SE = second_stage_res$se,\n  ci_lo = second_stage_res$ci.lb,\n  ci_hi = second_stage_res$ci.ub,\n  tau_2 = second_stage_res$tau2\n) %>%\n  kable(digits = 3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> rowname </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> SE </th>\n   <th style=\"text-align:right;\"> ci_lo </th>\n   <th style=\"text-align:right;\"> ci_hi </th>\n   <th style=\"text-align:right;\"> tau_2 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> intrcpt </td>\n   <td style=\"text-align:right;\"> 1.214 </td>\n   <td style=\"text-align:right;\"> 0.088 </td>\n   <td style=\"text-align:right;\"> 1.034 </td>\n   <td style=\"text-align:right;\"> 1.394 </td>\n   <td style=\"text-align:right;\"> 0.13 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n#### Subgroup Analyses\n\n#### First Stage: Primary Study Analysis\n\nHere, I estimate treatment effect by classroom and by the female variable:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsubgroup_fs_res <- bryan_dat %>%\n  group_by(classroom, female) %>%\n  do(estimate_effects(., stage = \"two\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n1 coefficient  not defined because the design matrix is rank deficient\n```\n\n\n:::\n:::\n\n\n\n#### Second Stage: Meta-Analysis\n\nThen, in the second stage, I synthesize the block specific subgroup effects.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nestimate_subgroup_mod <- function(dat){\n  \n  second_stage_res <- rma.uni(yi = estimate, \n                              sei = std_error,\n                              data = dat, \n                              method = \"REML\", \n                              test = \"knha\")\n  \n  res <- tibble(\n      rowname = rownames(second_stage_res$b),\n      est = as.vector(second_stage_res$b),\n      SE = second_stage_res$se,\n      ci_lo = second_stage_res$ci.lb,\n      ci_hi = second_stage_res$ci.ub,\n      tau_2 = second_stage_res$tau2\n    )\n\n  return(res)\n  \n}\n  \nsubgroup_fs_res %>%\n  group_by(female) %>%\n  do(estimate_subgroup_mod(.)) %>%\n  kable(digits = 3)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: 2 studies with NAs omitted from model fitting.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: 1 study with NAs omitted from model fitting.\n```\n\n\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> female </th>\n   <th style=\"text-align:left;\"> rowname </th>\n   <th style=\"text-align:right;\"> est </th>\n   <th style=\"text-align:right;\"> SE </th>\n   <th style=\"text-align:right;\"> ci_lo </th>\n   <th style=\"text-align:right;\"> ci_hi </th>\n   <th style=\"text-align:right;\"> tau_2 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Female </td>\n   <td style=\"text-align:left;\"> intrcpt </td>\n   <td style=\"text-align:right;\"> 1.234 </td>\n   <td style=\"text-align:right;\"> 0.124 </td>\n   <td style=\"text-align:right;\"> 0.979 </td>\n   <td style=\"text-align:right;\"> 1.489 </td>\n   <td style=\"text-align:right;\"> 0.290 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Not Female </td>\n   <td style=\"text-align:left;\"> intrcpt </td>\n   <td style=\"text-align:right;\"> 1.179 </td>\n   <td style=\"text-align:right;\"> 0.101 </td>\n   <td style=\"text-align:right;\"> 0.972 </td>\n   <td style=\"text-align:right;\"> 1.387 </td>\n   <td style=\"text-align:right;\"> 0.171 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}